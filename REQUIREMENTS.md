# Техническое задание: Система управления калиткой

## Описание проекта

Проект предназначен для управления электромагнитным замком калитки с использованием микроконтроллера ATtiny13a. Система обеспечивает два режима работы, управление осуществляется через одну цепь (внутренняя и внешняя кнопки подключены параллельно).

## Аппаратная конфигурация

### Используемые компоненты
- **Микроконтроллер**: ATtiny13a (частота: 1.2 МГц)
- **Замок**: Электромагнитный замок (управление катушкой через ключи ULN2003A)
- **Кнопка**: Две кнопки (внутренняя и внешняя), подключенные параллельно
- **Индикация**: Светодиод + активный зуммер

### Подключение выводов ATtiny13a
| Пин | Назначение | Описание |
|-----|------------|----------|
| `PB0` (MOSI) | `buttOuterMOSI` | Не используется (виртуальный GND) |
| `PB1` (MISO) | `buttInnerMISO` | Кнопка (с подтяжкой вверх) |
| `PB2` | `ledPin` | Светодиод (выход) |
| `PB3` | `buzzPin` | Зуммер (выход) |
| `PB4` | `coilPin` | Управление катушкой замка (выход) |

**Примечание по катушке**: Подача высокого уровня на `coilPin` → катушка включена → дверь заперта. Снятие напряжения (низкий уровень) → дверь открыта.

### Текущая реализация таймеров
- **Таймер 0 (TIM0)**: Базовый таймер, прерывание каждые ~0.01 сек (853 мкс × 12 = 10.236 мс)
- **Timer1**: Счетчик для катушки (замка)
- **Timer2**: Счетчик для обработки кнопок (debounce, длительное нажатие)
- **Timer4**: Счетчик для светодиода и зуммера

## Функциональные требования

### Режим Р1: "Постоянно открыто"
- **Инициализация**: Всегда активируется при включении устройства (по умолчанию)
- **Состояние замка**: Электромагнит постоянно обесточен (замок разблокирован)
- **Индикация**:
  - Светодиод **мигает** медленно (прерывистые вспышки)
  - Зуммер издает **короткие прерывистые сигналы** синхронно со светодиодом
- **Управление**: Короткие нажатия кнопки (0.1 с) **игнорируются**
- **Особенность**: Состояние режима **НЕ сохраняется** в ПЗУ (EEPROM)

### Режим Р2: "Управление замком"
- **Инициализация**: Состояние режима **НЕ сохраняется** в ПЗУ (EEPROM)
- **Поведение в покое**:
  - Электромагнит под напряжением (замок заблокирован)
  - Светодиод горит **постоянно** (индикация режима)
  - Зуммер выключен
- **Поведение при открытии**:
  - Короткое нажатие кнопки (0.1 с) → открытие калитки на **4 секунды**
  - Во время открытия (4 сек):
    - Электромагнит обесточен (замок разблокирован)
    - Светодиод **быстро мигает** (период 0.1 с)
    - Зуммер издает **быстрые прерывистые сигналы** синхронно со светодиодом (период 0.1 с)

### Переключение режимов Р1 ↔ Р2
- **Условие**: Нажатие кнопки длительностью **3 секунды**
- **Изменение режима**: Происходит сразу после удержания кнопки в течение 3 секунд
- **Состояние замка**: Меняется согласно новому режиму (Р1→Р2: закрывается, Р2→Р1: открывается)
- **Индикация переключения**: 
  - После выполнения условия (3 секунды удержания) зуммер и светодиод начинают быстро мигать (период 0.1 с), как при открытии замка
  - Сигнал длится **4 секунды**, независимо от дальнейшего удержания кнопки

## Технические параметры

| Параметр | Значение | Описание |
|----------|----------|----------|
| `INTERV_DEBOUNCE` | 9 | Debounce кнопки: 0.1 с (9 × 0.01 с) |
| `INTERV_LED` | 9 | Быстрое мигание: период 0.1 с (9 × 0.01 с) |
| `INTERV_LONG` | 29 | Длительное нажатие: 3.0 с (30 × 0.1 с) |
| `COIL_DURATION` | 399 | Длительность открытия: 4.0 с (399 × 0.01 с) |
| `LED_SLOW_MAX` | 20 | Медленное мигание: период 2.0 с (20 × 0.1 с) |

## Схема работы программы

```
Инициализация → Р1 (замок открыт, LED медленно мигает + зуммер)
                ↓
            [Кнопка 3с] → Переключение режима (4с быстрое мигание LED/звук)
                ↓
            Р2 (замок закрыт, LED горит постоянно, зуммер выключен)
                ↓
        [Кнопка 0.1с] → Открытие 4с (быстрое мигание LED + зуммер)
                ↓
         Затем автоматический возврат в Р2 (покой)
                ↓
         [Кнопка 3с] → Переключение режима (4с быстрое мигание LED/звук)
                ↓
            Р1 (замок открыт, LED медленно мигает + зуммер)
```

## Логика работы (состояния)

| Режим | `press3s` | Замок (катушка) | LED | Зуммер | Примечание |
|-------|-----------|----------------|-----|--------|------------|
| Р1 (покой) | `1` | Выключена (открыт) | Медленное мигание (2.0 с) | Синхронно с LED | Короткие нажатия игнорируются |
| Р2 (покой) | `0` | Включена (заперт) | Постоянно горит | Выключен | - |
| Р2 (открытие) | `0` | Выключена (открыт) | Быстрое мигание (0.1 с) | Синхронно с LED | 4 секунды |
| Переключение Р1↔Р2 | Переключение | Согласно новому режиму (Р1: выкл, Р2: вкл) | Быстрое мигание (0.1 с) | Синхронно с LED | После 3 с удержания, сигнал 4 с |

---

**Дата создания**: 2024  
**Версия**: 2.1  
**Статус**: Финальная версия
